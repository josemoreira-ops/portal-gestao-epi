<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portal de Gest√£o de EPI</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
  <!-- Seu HTML original permanece aqui (n√£o alterado) -->
  <div id="app">
     <!-- ... Todo o HTML visual permanece intacto ... -->
  </div>

<script>
/********************************************************************
 *  üî• VERS√ÉO CORRIGIDA DO SCRIPT ‚Äì SEM DUPLICA√á√ïES
 *  - Lista global de EPIs: selectedItems
 *  - Admiss√£o envia corretamente para o Apps Script
 *  - Demiss√£o permanece funcionando
 ********************************************************************/

// ========= VARI√ÅVEIS GLOBAIS =========
let selectedItems = [];   // Lista REAL de EPIs escolhidos
let currentFunctionDefaultEPIs = []; // EPIs carregados pela fun√ß√£o


/********************************************************************
 *  üîπ FUN√á√ÉO: Carregar EPIs da fun√ß√£o escolhida
 ********************************************************************/
function loadEPIsForFunction() {
    const role = document.getElementById("employeeFunction").value;

    // Limpa lista atual
    selectedItems = [];
    const epiContainer = document.getElementById("epiList");
    epiContainer.innerHTML = "";

    // üî• MAPA DE FUN√á√ÉO ‚Üí EPIs padr√£o (adicione mais se quiser)
    const defaultEPIsMap = {
        "Pintor": [
            { name: "Camisa UV", quantity: 1 },
            { name: "Bota", quantity: 1 },
            { name: "Luva", quantity: 1 }
        ],
        "Pedreiro": [
            { name: "Capacete", quantity: 1 },
            { name: "Bota", quantity: 1 },
            { name: "Luva", quantity: 2 }
        ]
    };

    currentFunctionDefaultEPIs = defaultEPIsMap[role] || [];

    currentFunctionDefaultEPIs.forEach(item => addEPI(item.name, item.quantity));
}


/********************************************************************
 *  üîπ FUN√á√ÉO: Adicionar item √† lista de EPIs escolhidos
 ********************************************************************/
function addEPI(name, quantity) {
    const date = new Date().toISOString().split("T")[0]; // Data padr√£o

    const epi = { name, quantity, date };
    selectedItems.push(epi);
    renderEPIList();
}


/********************************************************************
 *  üîπ FUN√á√ÉO: Remover item
 ********************************************************************/
function removeEPI(index) {
    selectedItems.splice(index, 1);
    renderEPIList();
}


/********************************************************************
 *  üîπ FUN√á√ÉO: Atualizar a lista visual na tela
 ********************************************************************/
function renderEPIList() {
    const container = document.getElementById("epiList");
    container.innerHTML = "";

    selectedItems.forEach((item, index) => {
        const div = document.createElement("div");
        div.classList.add("epi-item");
        div.innerHTML = `
            <span><b>${item.name}</b> ‚Äî Qtde: ${item.quantity}</span>
            <button onclick="removeEPI(${index})">Remover</button>
        `;
        container.appendChild(div);
    });
}


/********************************************************************
 *  üîπ FUN√á√ÉO: Enviar ADMISS√ÉO para Google Sheets
 ********************************************************************/
async function sendAdmissaoToSheets() {
    try {
        if (selectedItems.length === 0) {
            alert("Selecione ao menos um EPI antes de enviar.");
            return;
        }

        const dataEntrega = selectedItems[0].date; // Uma √∫nica data
        const listaEpis = selectedItems.map(e => `${e.name} (${e.quantity})`).join("; ");

        const data = {
            tipoDocumento: "Admiss√£o",
            nome: document.getElementById("employeeName").value,
            profissao: document.getElementById("employeeFunction").value,
            empresa: document.getElementById("companySelect").options[
                document.getElementById("companySelect").selectedIndex
            ].text,
            setor: document.getElementById("workSector").value,
            dataAdmissao: document.getElementById("admissionDate").value,
            dataEntrega: dataEntrega,
            listaEpis: listaEpis
        };

        await fetch(GOOGLE_SHEETS_CONFIG.UNIFIED, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams(data).toString()
        });

        console.log("‚úî Admiss√£o enviada com sucesso!");

    } catch (err) {
        console.error("Erro ao enviar admiss√£o:", err);
    }
}


/********************************************************************
 *  üîπ FUN√á√ÉO: Enviar DEMISS√ÉO (mantida como estava)
 ********************************************************************/
async function sendDemissaoToSheets(tipo, dados) {
    try {
        const baseData = {
            nome: document.getElementById('demissaoEmployeeName').value,
            rg: document.getElementById('demissaoEmployeeRG').value,
            cpf: document.getElementById('demissaoEmployeeCPF').value,
            profissao: document.getElementById('demissaoEmployeeFunction').value,
            empresa: document.getElementById('demissaoCompanySelect').options[
                document.getElementById('demissaoCompanySelect').selectedIndex
            ].text
        };

        let tipoDocumento = '';
        let episParaEnviar = dados.map(item => ({ nome: item.name, quantidade: item.quantity }));

        if (tipo === 'devolucao') tipoDocumento = 'Demiss√£o - Termo de Devolu√ß√£o';
        if (tipo === 'posse') tipoDocumento = 'Demiss√£o - Declara√ß√£o de Posse';

        const data = {
            ...baseData,
            tipoDocumento,
            epis: JSON.stringify(episParaEnviar)
        };

        await fetch(GOOGLE_SHEETS_CONFIG.UNIFIED, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams(data).toString()
        });

        console.log("‚úî Demiss√£o enviada: " + tipoDocumento);

    } catch (err) {
        console.error("Erro ao enviar demiss√£o:", err);
    }
}

/********************************************************************
 *  üîπ Fun√ß√£o de gerar PDF (mantida, mas sem quebrar admiss√£o)
 ********************************************************************/
function generatePDF() {
    const formType = document.getElementById("formType").value;

    if (formType === "admissao") sendAdmissaoToSheets();
    if (formType === "demissao-devolucao") sendDemissaoToSheets("devolucao", selectedItems);
    if (formType === "demissao-posse") sendDemissaoToSheets("posse", selectedItems);

    const element = document.getElementById("pdfArea");
    html2pdf().from(element).save();
}

</script>
</body>
</html>
